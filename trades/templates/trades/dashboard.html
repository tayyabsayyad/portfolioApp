{# trades/templates/trades/dashboard.html #}
{% extends "trades/base.html" %}
{% block title %}Dashboard — StageTracker{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h5 m-0">Dashboard</h1>
    <a href="{% url 'trade_list' %}" class="small text-muted">View trades</a>
  </div>

  <!-- Summary cards -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card-like text-center">
        <div class="small text-muted">Portfolio Value</div>
        <div id="total_value" class="h5 mt-2">—</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card-like text-center">
        <div class="small text-muted">Total Gain</div>
        <div id="total_gain" class="h5 mt-2">—</div>
        <div id="total_gain_pct" class="small text-muted"></div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card-like text-center">
        <div class="small text-muted">Unrealized P&L</div>
        <div id="unrealized" class="h5 mt-2">—</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card-like text-center">
        <div class="small text-muted">Open Positions</div>
        <div id="open_count" class="h5 mt-2">—</div>
      </div>
    </div>
  </div>

  <!-- Positions Table -->
  <div class="card-like mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="m-0">Positions</h6>
      <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle mb-0">
        <thead class="table-light small text-muted">
          <tr>
            <th scope="col">Ticker</th>
            <th scope="col" class="text-end">Qty</th>
            <th scope="col" class="text-end">Buy Avg Price</th>
            <th scope="col" class="text-end">Total Cost</th>
            <th scope="col" class="text-end">LTP</th>
            <th scope="col" class="text-end">Market Value</th>
            <th scope="col" class="text-end">P&L</th>
            <th scope="col" class="text-end">P&L %</th>
            <th scope="col" class="text-end">Days Held</th>
          </tr>
        </thead>
        <tbody id="positions_table_body">
          <tr><td colspan="9" class="small text-muted">Loading positions…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // helpers
  function formatNumber(v) {
    if (v === null || v === undefined) return '—';
    return Number(v).toLocaleString(undefined, {maximumFractionDigits:2});
  }
  function colorClassForNumber(n) {
    if (n === null || n === undefined) return 'text-muted';
    const val = Number(n);
    if (val > 0) return 'text-success';
    if (val < 0) return 'text-danger';
    return 'text-muted';
  }
  function computeDaysHeld(buy_iso) {
    if (!buy_iso) return '—';
    const buy = new Date(buy_iso);
    const now = new Date();
    const diff = now - buy;
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }

  // render table
  function renderPositions(positions) {
    const tbody = document.getElementById('positions_table_body');
    tbody.innerHTML = '';
    if (!positions || positions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="small text-muted">No open positions</td></tr>';
      return;
    }

    positions.forEach(p => {
      const pnlCls = colorClassForNumber(p.unrealized_pnl);
      const pctCls = colorClassForNumber(p.pnl_pct);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="fw-semibold">${p.ticker}</div>
          <div class="small text-muted"><a href="/trades/${p.id}/" class="text-decoration-none small">Details</a></div>
        </td>
        <td class="text-end small">${formatNumber(p.quantity)}</td>
        <td class="text-end small">${formatNumber(p.buy_price)}</td>
        <td class="text-end small">${formatNumber(p.cost)}</td>
        <td class="text-end small">${formatNumber(p.last_price)}</td>
        <td class="text-end small">${formatNumber(p.market_value)}</td>
        <td class="text-end ${pnlCls} small">${formatNumber(p.unrealized_pnl)}</td>
        <td class="text-end ${pctCls} small">${p.pnl_pct !== null ? p.pnl_pct.toFixed(2) + '%' : '—'}</td>
        <td class="text-end small">${computeDaysHeld(p.buy_date)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // fetch data
  async function fetchPortfolio() {
    try {
      const res = await fetch("{% url 'portfolio_value_api' %}");
      const data = await res.json();
      const pos = data.positions || [];

      // summary
      document.getElementById('total_value').textContent = formatNumber(data.total_value);
      document.getElementById('open_count').textContent = pos.length;

      const tg = document.getElementById('total_gain');
      const tgPct = document.getElementById('total_gain_pct');
      tg.textContent = formatNumber(data.total_gain);
      tg.className = colorClassForNumber(data.total_gain) + ' h5 mt-2';
      tgPct.textContent = data.total_gain_pct ? data.total_gain_pct.toFixed(2) + '%' : '';
      tgPct.className = colorClassForNumber(data.total_gain_pct);

      const unrealEl = document.getElementById('unrealized');
      unrealEl.textContent = formatNumber(data.total_unrealized);
      unrealEl.className = colorClassForNumber(data.total_unrealized) + ' h5 mt-2';

      renderPositions(pos);
    } catch (e) {
      console.error(e);
      document.getElementById('positions_table_body').innerHTML =
        '<tr><td colspan="9" class="text-danger small">Error loading positions — try again.</td></tr>';
    }
  }

  fetchPortfolio();
  document.getElementById('refreshBtn').addEventListener('click', fetchPortfolio);
  setInterval(fetchPortfolio, 45000);
</script>
{% endblock %}